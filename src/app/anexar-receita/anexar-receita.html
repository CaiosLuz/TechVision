<app-menu-superior></app-menu-superior>
<div class="container-fluid">
  <div class="row justify-content-center">

    <!-- Coluna esquerda: Upload + tabela ou formulário -->
    <div class="col-6">

    <!-- CARD PRINCIPAL -->
    <div class="card shadow-sm p-4 mt-5">

      <!-- Título -->
      <div class="text-center mb-4">
        <p class="h4 fw-bold mb-1">Anexe a Receita</p>
        <img src="images/anexar-receita/processo3.png" alt="" class="img-fluid" style="width: 14rem;">
      </div>

      <!-- BOTÕES DE AÇÃO -->
      <div class="d-flex justify-content-center gap-2 mb-4">
        <button class="btn btn-outline-primary"
                [class.active]="!preencherManual"
                (click)="preencherManual=false">
          Enviar Receita
        </button>

        <button class="btn btn-outline-primary"
                [class.active]="preencherManual"
                (click)="preencherManual=true">
          Preencher Manual
        </button>

        <button class="btn btn-outline-secondary"
                (click)="pularEtapa()">
          Pular etapa
        </button>
      </div>

      <!-- UPLOAD DE RECEITA -->
      <div *ngIf="!preencherManual" class="text-center">

        <p class="h5 mb-1">Anexe sua receita médica</p>
        <p class="text-muted mb-3">Selecione ou tire uma foto da sua receita</p>

        <input class="form-control mb-3" type="file" (change)="onFileSelected($event)">

        <button class="btn btn-primary w-100"
                (click)="enviarImagem()"
                [disabled]="!imagemSelecionada || carregando">
          {{ carregando ? 'Processando...' : 'Enviar imagem' }}
        </button>

        <!-- TABELA DE RESULTADO -->
        <div *ngIf="esfericoOD !== null" class="mt-4">
          <h5 class="fw-bold text-center mb-2">Resultado da leitura</h5>

          <div class="table-responsive">
            <table class="table table-bordered text-center">
              <thead class="table-light">
                <tr>
                  <th>Grau</th>
                  <th>Esférico OD</th>
                  <th>Esférico OE</th>
                  <th>Cilindro OD</th>
                  <th>Cilindro OE</th>
                  <th>Eixo OD</th>
                  <th>Eixo OE</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th>1</th>
                  <td>{{ esfericoOD }}</td>
                  <td>{{ esfericoOE }}</td>
                  <td>{{ cilindricoOD }}</td>
                  <td>{{ cilindricoOE }}</td>
                  <td>{{ eixoOD }}</td>
                  <td>{{ eixoOE }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- FORMULÁRIO MANUAL -->
      <div *ngIf="preencherManual">

        <p class="h5 text-center mb-3 fw-bold">Preencha os dados manualmente</p>

        <form (ngSubmit)="salvarManual()">

          <div class="row g-3">
            <div class="col">
              <label class="form-label fw-semibold">Esférico OD</label>
              <input type="number" step="0.25" class="form-control"
                    [(ngModel)]="esfericoOD" name="esfericoOD">
            </div>
            <div class="col">
              <label class="form-label fw-semibold">Esférico OE</label>
              <input type="number" step="0.25" class="form-control"
                    [(ngModel)]="esfericoOE" name="esfericoOE">
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col">
              <label class="form-label fw-semibold">Cilindro OD</label>
              <input type="number" step="0.25" class="form-control"
                    [(ngModel)]="cilindricoOD" name="cilindricoOD">
            </div>
            <div class="col">
              <label class="form-label fw-semibold">Cilindro OE</label>
              <input type="number" step="0.25" class="form-control"
                    [(ngModel)]="cilindricoOE" name="cilindricoOE">
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col">
              <label class="form-label fw-semibold">Eixo OD</label>
              <input type="number" class="form-control"
                    [(ngModel)]="eixoOD" name="eixoOD">
            </div>
            <div class="col">
              <label class="form-label fw-semibold">Eixo OE</label>
              <input type="number" class="form-control"
                    [(ngModel)]="eixoOE" name="eixoOE">
            </div>
          </div>

          <div class="text-center mt-4">
            <button class="btn btn-success px-5" type="submit">
              Salvar
            </button>
          </div>

        </form>

      </div>

    </div>
  </div>

    <!-- Barra vertical -->
    <div class="col-auto mt-5">
      <div class="barra-vertical"></div>
    </div>

    <!-- Coluna direita: informações do óculos -->
    <div class="col-3 mt-5">
      <img [src]="produto?.imagens_produto?.[0]?.url || 'images/detalhe-produto/produto-secundario.png'" alt="" class="img-fluid mb-3">
      <div class="row">
        <p class="tipo mb-0">{{ produto?.nome }}</p>
        <p class="preco">R$ {{ produto?.preco }}</p>
        <p class="titulo">Selecionados:</p>
        <div class="barra-horizontal mb-2"></div>
        <p class="infos"><strong>Lente:</strong> {{ tipoLente }}</p>
        <p class="infos"><strong>Espessura:</strong> {{ espessura }}</p>
        <p class="infos"><strong>Tratamentos:</strong></p>
        <div *ngIf="tratamentosSelecionados.length > 0; else nenhumTratamento">
          <ul class="lista-tratamentos">
            <li *ngFor="let t of tratamentosSelecionados">{{ t }}</li>
          </ul>
        </div>

        <ng-template #nenhumTratamento>
          <p class="infos text-muted">Nenhum tratamento selecionado</p>
        </ng-template>
      </div>
      <button 
                    class="btn btn-primary mt-4 w-100"
                    style="border-radius: 12px; font-size: 1.1rem; padding: .7rem;"
                    (click)="irParaCarrinho()"
                  [disabled]="!esfericoOD && !esfericoOE">
                    Avançar →
                </button>
    </div>

  </div>
</div>
